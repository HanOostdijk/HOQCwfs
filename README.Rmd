---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

## HOQCwfs

<!-- badges: start -->
<!-- badges: end -->

### R Web Feature Service (WFS) read-only interface
This package contains functions to retrieve information from a Web Feature Service (WFS) resource. 
It generates HTML requests for the WFS API.

### Installation

You can install this version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("HanOostdijk/HOQCwfs")
```

### Example

A typical workflow looks like this :

#### Initialize
Load the package and indicate which WFS resource you want to access and the version that you want to use for the requests and their answers. 
In this way you can avoid specifying this in the separate function calls.

```{r initialize1}
library(HOQCwfs)
WFS_set_url()      # default https://geoweb.amstelveen.nl/geoserver/topp/wfs will be used
WFS_set_version()  # default 1.1.0 will be used
```

#### Look at the possibilities the WFS resource has to offer 
Retrieve the GetCapabilities document that describes the various features of the WFS resource and the actions that can be done. Because I have only read-access to WFS resources I am most interested in the query actions. An 'impression' of the rather extensive GetCapabilities xml document is given below.
```{r getcapabilities1}
xmlcap <- WFS_getcapabilities()  
class(xmlcap)
```
```{r getcapabilities2,echo=F}
HOQCutil::cap.out(print(xmlcap),width=110)
```
The xml document can be written to a local dataset with the `out_path` argument:
```{r getcapabilities3,eval=F}
xmlcap <- WFS_getcapabilities(out_path='mycap.xml') 
```

#### Look at the various features of the WFS resource
From the GetCapabilities document we can extract the features that are available:
```{r featuretypes1}
ft1 <- WFS_featuretypes(xmlcap)
dim(ft1)
```
```{r featuretypes2,echo=F}
ft2 <- WFS_featuretypes(xmlcap,
       filternames=stringr::fixed("bomen", ignore_case = T))
```
When there are many features (`r dim(ft1)[1]` in this case) and we are just interested in feature names that contain the characters 'bomen' (i.e. 'trees') we can filter the names in the following way that results in only `r dim(ft2)[1]` cases
```{r ref.label='featuretypes2',eval=F}
```
```{r featuretypes3}
class(ft2)
dim(ft2)
ft2$layer
str(head(ft2,2)) # show only first two 'bomen' featuretypes 
```
```{r describefeaturetype1,echo=F}
bomen_fields_1_3<- WFS_describefeaturetype(ft2$layer[c(1,3)])
```

#### Look at the data fields of featuretypes
For this we use the function `WFS_describefeaturetype` that executes the WFS `DescribeFeatureType` request. 
As an example lets us look at the first and third featuretype in ft2 (`r glue::glue_collapse(glue::backtick(ft2$layer[c(1,3)]),last=" and ")`). Here we only show the first `5` rows of the result tibble of `r dim(bomen_fields_1_3)[1]` rows.
```{r ref.label='describefeaturetype1',eval=F}
```
```{r describefeaturetype2}
head(bomen_fields_1_3,5)
```
Because we later will use the fields of `topp:gidw_groenbomen` we will show all fields for this featuretype. Because we now request only one featuretype we can save the result of `DescribeFeatureType` in an xml file. Then we have the standard output:
```{r describefeaturetype3}
WFS_describefeaturetype("topp:gidw_groenbomen",out_path = 'desc.xml')
```
and the `desc.xml` file with its contents:
```{r describefeaturetype4,echo=F}
HOQCutil::cap.out(cat(readLines("desc.xml",warn = F),sep='\n'), width=110) 
```
```{r unlink, echo=F}
unlink('desc.xml')
```

#### Retrieve the actual data
Now that we know the metadata of our resource we can actually retrieve the attributes and geometrical data of the features. We do this with `WFS_getfeature('typename')` to:  
- retrieve all features with all attributes and the geometry: The `id` attribute will also be returned 
- retrieve some features and the geometry: add `cql_filter=` or `filter=` with a filter expression
- retrieve all features for some attributes and the geometry: add `propertyname='a1,a2'` to select the attributes `a1` and `a2`. The `id` attribute and the `geometry` will also be returned 
- retrieve a subset of one of the above: add `maxfeatures=` (1.1.0) or `count=` (2.0.0) optionally in combination with `startindex=`

If we are only interested in the number of features that would be returned we can add `resultType=hits` to any of the above. This only returns this number without any other data.

Examples:

##### retrieve all features with all attributes and the geometry
```{r}
typename  <- 'topp:gidw_groenbomen'
wfs1      <-  WFS_getfeature(typename)
class(wfs1)
print(wfs1,n=5) # show only first 5 features
```


##### retrieve some features 
For non-complex queries the `cql_filter` can be used. The features for the tree `Prunus serrulata 'Kanzan'` can be queried in the following way. The numbers of quotes in a query is often confusing (for me at least): here a set of quotes is needed because `boom_omschrijf` is a character field and quotes around 'Kanzan' have to be duplicated. 

```{r}
tree_name <- "Prunus serrulata ''Kanzan''"  
tree_exp  <- glue::glue("boom_omschrijf='{tree_name}'")
print(tree_exp)
wfs2      <-  WFS_getfeature(typename,cql_filter=tree_exp )
print(wfs2,n=5,digits=5) # show only first 5 features, 5 digits in geometry
```

##### retrieve some attributes 
When we are only interested in the 'omschrijvingen' (descriptions) fields we can add the `propertyname` argument:

```{r}
tree_name <- "Prunus serrulata ''Kanzan''"  
tree_exp  <- glue::glue("boom_omschrijf='{tree_name}'")
fields    <- 'boom_omschrijf,objec_omschrijf'
wfs3      <-  WFS_getfeature(typename,cql_filter=tree_exp,propertyname=fields )
print(wfs3,n=5,digits=5) # show only first 5 features, 5 digits in geometry
```

##### retrieve the number of results 
If we want to know beforehand the number of features that a query would return we can add the `resultType=hits` argument:

```{r}
  WFS_getfeature(typename,cql_filter=tree_exp,propertyname=fields,resultType='hits' )
```

##### change the Spatial Reference System  
In the output of the previous examples we saw that the coordinates in the geometry were denoted in the Coordinate Reference System (CRS) that is used in the Netherlands: 'Amersfoort / RD New' also known as 'EPSG:28992'. If we want to have these coordinates denoted in the more commonly used 'WGS 84' (EPSG:4326) in terms of longitude and latitude we can add the `srsName` argument. SRS ([Spatial Reference System](https://en.wikipedia.org/wiki/Spatial_reference_system)) is a synonym for CRS.

```{r}
wfs4      <-  WFS_getfeature(typename,cql_filter=tree_exp,propertyname=fields,srsName='EPSG:4326' )
print(wfs4,n=5,digits=5) # show only first 5 features, 5 digits in geometry
```

##### retrieve a subset of the query results with `startindex`, `maxfeatures` and `count` and using `verbose` 
With the `startindex` and `maxfeatures` (1.1.0) or `count` (2.0.0) argument a subset of a query is produced. The `WFS__getfeature` functions changes the argument when necessary. By added the `verbose=T` clause the generated request url will be displayed. Notice that `startIndex=2` indicates that the first feature to be retrieved is number 3. In other words `startIndex` indicates the number of records to skip.

```{r eval=F}
wfs5a     <-  WFS_getfeature(typename,cql_filter=tree_exp,startIndex=2,maxfeatures=6,
                             propertyname=fields,srsName='EPSG:4326'
                             ,verbose=T,version='1.1.0' )
```
```{r echo=F}

HOQCutil::cap.out({
wfs5a     <-  WFS_getfeature(typename,cql_filter=tree_exp,startIndex=2,maxfeatures=6,
                             propertyname=fields,srsName='EPSG:4326'
                             ,verbose=T,version='1.1.0' )  
}, width=93)
```
```{r}
print(wfs5a,n=5,digits=5) # show only first 5 features, 5 digits in geometry
```

```{r eval=F}
wfs5b     <-  WFS_getfeature(typename,cql_filter=tree_exp,startIndex=2,maxfeatures=6,
                             propertyname=fields,srsName='EPSG:4326'
                             ,verbose=T,version='2.0.0' )
```
```{r echo=F}
HOQCutil::cap.out({
wfs5b     <-  WFS_getfeature(typename,cql_filter=tree_exp,startIndex=2,maxfeatures=6,
                             propertyname=fields,srsName='EPSG:4326'
                             ,verbose=T,version='2.0.0' )
}, width=93)
```
```{r}
identical(wfs5a,wfs5b)
```







