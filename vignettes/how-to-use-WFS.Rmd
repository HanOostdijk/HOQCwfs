---
title: "How to use the HOQCwfs package"
output: 
  rmarkdown::html_vignette:
    toc: true 
    toc_depth: 5
vignette: >
  %\VignetteIndexEntry{How to use the HOQCwfs package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup,echo=F}
library(HOQCwfs)
```

### Introduction {#introduction}
This package contains functions to retrieve information from a [Web Feature Service](https://en.wikipedia.org/wiki/Web_Feature_Service) (WFS) resource. 
The [Open Geospatial Consortium](http://www.opengeospatial.org/) WFS  Interface Standard provides an interface allowing requests for geographical features across the web using platform-independent calls. This package generates such calls in the form of HTML requests in [GET or POST](https://www.w3schools.com/tags/ref_httpmethods.asp) format. Such a request is normally invisible to the user but can be made visible by adding `httrverbose=T` to the function call. 

In this vignette we use a WFS data source that contains information about the trees in the municipality where I live. Apart from the name of the species each record also contains the exact location of the tree.

We will start with an example that retrieves trees of a certain species in a certain [bounding box](https://en.wikipedia.org/wiki/Minimum_bounding_box#Axis-aligned_minimum_bounding_box).  
To do this we use the [GetFeature](https://docs.geoserver.org/stable/en/user/services/wfs/reference.html#getfeature) operation of WFS that is called by the package function `WFS_getfeature`. Assuming we did not do a misspecification the result will be a [simple features]() (`sf`) object. An `sf` object (managed by the R package [sf](https://cran.r-project.org/package=sf)) is a `data.frame` with spatial attributes. Instead of reading the whole data set and doing a filtering on the resulting `data.frame` we can add the filter to the `GetFeature` operation and retrieve only the part that we need. For large files this is obviously more efficient.  

From the contents you can deduce that we introduce the package with a typical use case for the `WFS_getfeature` function ([GetFeature](https://docs.geoserver.org/stable/en/user/services/wfs/reference.html#getfeature) operation). After that, we show how to find out what can be done with the WFS resource by using the `WFS_getcapabilities` ([GetCapabilities](https://docs.geoserver.org/stable/en/user/services/wfs/reference.html#getcapabilities) operation) function to see which 'sub datasets' (`featuretypes`) can be use and with the `WFS_describetype` ([DescribeFeatureType](https://docs.geoserver.org/stable/en/user/services/wfs/reference.html#describefeaturetype) operation) to see which fields a `featuretype` contains.  
After that we gradually introduce the possibilities to fine-tune the `WFS_getfeature` results.

### Introductory example {#intro-example}
In this first example we combine a text filter with a spatial filter: we want to retrieve some attributes of all trees of the species `Alnus glutinosa 'Laciniata'` in a certain area. So we need the call to `WFS_getfeature` that is done in the lines `#11` and `#12`. I will start by mentioning the arguments that are not specified there:  

- `url` is not specified and therefore its default is used that can be set by `WFS_set_url` and that standard is set to `r WFS_get_url()`   
- `version` is not specified and therefore its default is used that can be set by `WFS_set_version` and that standard is set to `r WFS_get_version()`  
- `httrType` is not specified and therefore its default `GET` is used
- `typename` in `#11` (and `#3`) indicate the `featuretype` we are interested in. See [Look at the various features of the WFS resource](#look-at-features) section to find out which are available
- `cql_filter` in `#11` (and `#10`) is the actual filter. See the  [Common Query Language (CQL) Tutorial](https://docs.geoserver.org/stable/en/user/tutorials/cql/cql_tutorial.html) for some general information.
Apart from `cql_filter=` we can also have `filter=` (see section **TODO**) that expects a filter in terms of `xml` expressions. However hat is not used here.Here the query consists of two parts connected with the logical operator `and` : 
  - the text filter part in lines `#5` and `#6` that indicates that the field `boom_omschrijf` should have the value `Alnus glutinosa 'Laciniata'` . Note the double quotes around `Laciniata` ! The output of line `#6` shows you how the text filter should be coded
  - the spatial filter is defined in lines `#7`, `#8` and `#9` : the first line defines the lower-left and upper-right point of the area we are interested in (in coordinates `WGS84` or alternatively named `EPSG:4326`) and the second line and last line formats this in CQL terms. The output of line `#9` shows you how this spatial filter should be coded.
- `propertyname` in line `#11` (and `#4`) indicate which fields will be returned in the `sf` object. Beside the two mentioned the `id` and `geometry` fields are also returned.
- `srsName` in line `#12` indicate in which Coordinate Reference System (CRS) the coordinates in the result will be specified. If not specified the default CRS for the featuretype will be used. In this case that is `EPSG:28992`. See [Look at the various features of the WFS resource](#look-at-features).

```{r intro_example_1}
# devtools::install_github("HanOostdijk/HOQCwfs",build_vignettes=TRUE)       #1

library(HOQCwfs)                                                             #2
typename  <- 'topp:gidw_groenbomen'                                          #3
fields    <- 'boom_omschrijf,objec_omschrijf'                                #4
tree_name <- "Alnus glutinosa ''Laciniata''"                                 #5 
( tree_exp  <- glue::glue("boom_omschrijf='{tree_name}'") )                  #6
bbox_wgs84 <- c(4.860793, 52.313319, 4.861587, 52.316493 )                   #7
bbox_spec <- paste0(glue::glue_collapse(bbox_wgs84,sep=','),",'EPSG:4326'")  #8
( bbox_spec <- paste0('bbox(geometrie,',bbox_spec,')') )                     #9
cql_spec  <- paste0(tree_exp,' and ',bbox_spec )                             #10
wfs_ie    <-  WFS_getfeature(typename,cql_filter=cql_spec,                   #11
                             propertyname=fields,srsName='EPSG:4326' )       #12
dim(wfs_ie)                                                                  #13
print(wfs_ie,n=2,digits=5)                                                   #14
```
To see the expression that will be sent to the WFS server the argument `httrverbose = T` can be added. This will give some lines of information about the request. Only the first two lines are shown here:
```{r intro_example_2a,eval=F}

wfs_ie    <-  WFS_getfeature(typename,cql_filter=cql_spec,                   
                             propertyname=fields,srsName='EPSG:4326',
                             httrverbose = T) 
```
```{r intro_example_2b,echo=F}
x = HOQCutil::capture.output.both(
              WFS_getfeature(typename,cql_filter=cql_spec,                   
                             propertyname=fields,srsName='EPSG:4326',
                             httrverbose = T)  )
x = purrr::map_chr(x[1:2],URLdecode) 
HOQCutil::cap.out(cat(x)) 
```
[[back to contents]](#TOC)
 
### Workflow {#workflow}

A typical workflow looks like this :

#### Initialize {#initialize}
Load the package and indicate which WFS resource you want to access and the version that you want to use for the requests and their answers.
In this way you can avoid specifying this in the separate function calls.  
ALso specify the separator that by default will be used in generated XML fragments.

```{r initialize1}
library(HOQCwfs)
WFS_set_url()      # default https://geoweb.amstelveen.nl/geoserver/topp/wfs will be used
WFS_set_version()  # default 1.1.0 will be used
WFS_set_sep()      # default '\n' will be used
```

#### Look at the possibilities the WFS resource has to offer {#look-at-possibilities}
Retrieve the GetCapabilities document that describes the various features of the WFS resource and the actions that can be done. Because I have only read-access to WFS resources I am only interested in the query actions. An 'impression' of the rather extensive GetCapabilities xml document is given below.
```{r getcapabilities1}
xmlcap <- WFS_getcapabilities()  
class(xmlcap)
```
```{r getcapabilities2,echo=F}
HOQCutil::cap.out(print(xmlcap),width=110)
```
The xml document can be written to a local dataset with the `out_path` argument:
```{r getcapabilities3,eval=F}
xmlcap <- WFS_getcapabilities(out_path='mycap.xml') 
```
[[back to contents]](#TOC)
 
#### Look at the various features of the WFS resource {#look-at-features}
From the GetCapabilities document we can extract the features that are available:
```{r featuretypes1}
ft1 <- WFS_featuretypes(xmlcap)
dim(ft1)
```
```{r featuretypes2,echo=F}
ft2 <- WFS_featuretypes(xmlcap,
       filternames=stringr::fixed("bomen", ignore_case = T))
```
When there are many features (`r dim(ft1)[1]` in this case) and we are just interested in feature names that contain the characters 'bomen' (i.e. 'trees') we can filter the names in the following way that results in only `r dim(ft2)[1]` cases
```{r ref.label='featuretypes2',eval=F}
```
```{r featuretypes3}
class(ft2)
dim(ft2)
ft2$layer
str(ft2[3,]) # show only featuretype 'topp:gidw_groenbomen' 
```
```{r describefeaturetype1,echo=F}
bomen_fields_1_3<- WFS_describefeaturetype(ft2$layer[c(1,3)])
```
[[back to contents]](#TOC)

#### Look at the data fields of featuretypes {#look-at-data-fields}
For this we use the function `WFS_describefeaturetype` that executes the WFS `DescribeFeatureType` request. 
As an example lets us look at the first and third featuretype in ft2 (`r glue::glue_collapse(glue::backtick(ft2$layer[c(1,3)]),last=" and ")`). Here we only show the first `5` rows of the result tibble of `r dim(bomen_fields_1_3)[1]` rows.
```{r ref.label='describefeaturetype1',eval=F}
```
```{r describefeaturetype2}
head(bomen_fields_1_3,5)
```
Because we later will use the fields of `topp:gidw_groenbomen` we will show all fields for this featuretype. Because we now request only one featuretype we can save the result of `DescribeFeatureType` in an xml file. Then we have the standard output:
```{r describefeaturetype3}
WFS_describefeaturetype("topp:gidw_groenbomen",out_path = 'desc.xml')
```
and the `desc.xml` file with its contents:
```{r describefeaturetype4,echo=F}
HOQCutil::cap.out(cat(readLines("desc.xml",warn = F),sep='\n'), width=110) 
```
```{r unlink, echo=F}
unlink('desc.xml')
```
[[back to contents]](#TOC)

#### Retrieve the actual data {#retrieve}
Now that we know the metadata of our resource we can actually retrieve the attributes and geometrical data of the features. We do this with `WFS_getfeature` to:  

- [retrieve all features with all attributes and the geometry](#retrieve-all): The `id` attribute will also be returned 
- [retrieve some features](#retrieve-some-features) and the geometry: add `cql_filter=` or `filter=` with a filter expression
- [retrieve all features for some attributes](#retrieve-attributes) and the geometry: add `propertyname='a1,a2'` to select the attributes `a1` and `a2`. The `id` attribute and the `geometry` will also be returned 
- [change the Spatial Reference System](#change-crs) (i.e. the coordinates of the features)
- [retrieve a subset](#retrieve-subset) of one of the above: add `maxfeatures=` or `count=` optionally in combination with `startindex=`
- [retrieve all features in a bounding box](#retrieve_boundingbox)
- [retrieve features in a bounding box with additional filtering](#retrieve_boundingbox-cqlfilter)

If we are only interested in the [number of features](#number-of-features) that would be returned we can add `resultType=hits` to any of the above. This only returns this number without any other data.

Examples:

[[back to contents]](#TOC) 

##### retrieve all features with all attributes and the geometry {#retrieve-all}
```{r retrieve-all1}
typename  <- 'topp:gidw_groenbomen'
wfs1      <-  WFS_getfeature(typename)
class(wfs1)
print(wfs1,n=5) # show only first 5 features
```

[[back to contents]](#TOC) [[back to 'Retrieve the actual data']](#retrieve)

##### retrieve some features {#retrieve-some-features}
For non-complex queries the `cql_filter` can be used. The features for the tree `Prunus serrulata 'Kanzan'` can be queried with the following code. The number of quotes in a query is often confusing (for me at least): here a set of quotes is needed because `boom_omschrijf` is a character field and quotes around 'Kanzan' have to be duplicated. 

```{r retrieve-some-features}
typename  <- 'topp:gidw_groenbomen'
tree_name <- "Prunus serrulata ''Kanzan''"  
tree_exp  <- glue::glue("boom_omschrijf='{tree_name}'")
print(tree_exp)
wfs2      <-  WFS_getfeature(typename,cql_filter=tree_exp )
print(wfs2,n=5,digits=5) # show only first 5 features, 5 digits in geometry
```
[[back to contents]](#TOC) [[back to 'Retrieve the actual data']](#retrieve)

##### retrieve some attributes  {#retrieve-attributes}
When we are only interested in the 'omschrijvingen' (descriptions) fields we can add the `propertyname` argument to request the fields `boom_omschrijf` and `objec_omschrijf`. Note that the `id` and `geometry` fields are always included.

```{r retrieve-attributes}
typename  <- 'topp:gidw_groenbomen'
tree_name <- "Prunus serrulata ''Kanzan''"  
tree_exp  <- glue::glue("boom_omschrijf='{tree_name}'")
fields    <- 'boom_omschrijf,objec_omschrijf'
wfs3      <-  WFS_getfeature(typename,cql_filter=tree_exp,propertyname=fields )
print(wfs3,n=5,digits=5) # show only first 5 features, 5 digits in geometry
```
[[back to contents]](#TOC) [[back to 'Retrieve the actual data']](#retrieve)

##### retrieve the number of results {#number-of-features}
If we want to know beforehand the number of features that a query would return we can add the `resultType=hits` argument:

```{r number-of-features}
typename  <- 'topp:gidw_groenbomen'
tree_name <- "Prunus serrulata ''Kanzan''"  
tree_exp  <- glue::glue("boom_omschrijf='{tree_name}'")
fields    <- 'boom_omschrijf,objec_omschrijf'
  WFS_getfeature(typename,cql_filter=tree_exp,propertyname=fields,resultType='hits' )
```
[[back to contents]](#TOC) [[back to 'Retrieve the actual data']](#retrieve)

##### change the Spatial Reference System  {#change-crs}
In the output of the previous examples we saw that the coordinates in the geometry were denoted in the Coordinate Reference System (CRS) that is used in the Netherlands: 'Amersfoort / RD New' also known as 'EPSG:28992'. If we want to have these coordinates denoted in the more commonly used 'WGS 84' (EPSG:4326) in terms of longitude and latitude we can add the `srsName` argument. SRS ([Spatial Reference System](https://en.wikipedia.org/wiki/Spatial_reference_system)) is a synonym for CRS.

```{r change-crs}
typename  <- 'topp:gidw_groenbomen'
tree_name <- "Prunus serrulata ''Kanzan''"  
tree_exp  <- glue::glue("boom_omschrijf='{tree_name}'")
fields    <- 'boom_omschrijf,objec_omschrijf'
wfs4      <-  WFS_getfeature(typename,cql_filter=tree_exp,propertyname=fields,srsName='EPSG:4326' )
print(wfs4,n=5,digits=5) # show only first 5 features, 5 digits in geometry
```
[[back to contents]](#TOC) [[back to 'Retrieve the actual data']](#retrieve)

##### retrieve a subset of the query results with `startindex`, `maxfeatures` and `count` and using `verbose` {#retrieve-subset}
With the `startindex` and `maxfeatures` (1.1.0) or `count` (2.0.0) argument a subset of a query is produced. The `WFS__getfeature` function will use the correct version. By adding the `verbose=T` clause the generated request url will be displayed so that you can verify this. Notice that `startIndex=2` indicates that the first feature to be retrieved is number 3. In other words `startIndex` indicates the number of records to skip.

```{r retrieve-subset1,eval=F}
typename  <- 'topp:gidw_groenbomen'
tree_name <- "Prunus serrulata ''Kanzan''"  
tree_exp  <- glue::glue("boom_omschrijf='{tree_name}'")
fields    <- 'boom_omschrijf,objec_omschrijf'
wfs5a     <-  WFS_getfeature(typename,cql_filter=tree_exp,startIndex=2,maxfeatures=6,
                             propertyname=fields,srsName='EPSG:4326'
                             ,verbose=T,version='1.1.0' )
```
```{r retrieve-subset2,echo=F}

HOQCutil::cap.out({
wfs5a     <-  WFS_getfeature(typename,cql_filter=tree_exp,startIndex=2,maxfeatures=6,
                             propertyname=fields,srsName='EPSG:4326'
                             ,verbose=T,version='1.1.0' )  
}, width=93)
```
```{rretrieve-subset3}
print(wfs5a,n=5,digits=5) # show only first 5 features, 5 digits in geometry
```

```{r retrieve-subset4,eval=F}
typename  <- 'topp:gidw_groenbomen'
tree_name <- "Prunus serrulata ''Kanzan''"  
tree_exp  <- glue::glue("boom_omschrijf='{tree_name}'")
fields    <- 'boom_omschrijf,objec_omschrijf'
wfs5b     <-  WFS_getfeature(typename,cql_filter=tree_exp,startIndex=2,maxfeatures=6,
                             propertyname=fields,srsName='EPSG:4326'
                             ,verbose=T,version='2.0.0' )
```
```{r retrieve-subset5,echo=F}
HOQCutil::cap.out({
wfs5b     <-  WFS_getfeature(typename,cql_filter=tree_exp,startIndex=2,maxfeatures=6,
                             propertyname=fields,srsName='EPSG:4326'
                             ,verbose=T,version='2.0.0' )
}, width=93)
```
```{r retrieve-subset6}
identical(wfs5a,wfs5b)
```
[[back to contents]](#TOC) [[back to 'Retrieve the actual data']](#retrieve)

##### retrieve features in a bounding box {#retrieve_boundingbox}
When you want to retrieve all features in a bounding box the `bbox=` argument can be used. When specifying the coordinates of the bounding box it is assumed that the default CRS is used.
The default CRS for `typename` is `EPSG:28992` (see [Look at the various features of the WFS resource](#look-at-features) ). Therefore when using `WGS 84` (`EPSG:4326`) the EPSG code has to be added to the specification. Note that this only impacts the features that are selected and not their coordinates. Use `srsName='EPSG:4326'` when you want `WGS 84` coordinates.  
In the two examples below we are interested in the same area but in the first case we use `EPSG:28992` coordinates and in the second `WGS 84` coordinates. Therefore the same features are selected
```{r retrieve_boundingbox1}
bbox_wgs84 <- c(4.860793, 52.313319, 4.861587, 52.316493 )
bbox_28992 <- convert_bbox(bbox_wgs84,'EPSG:4326','EPSG:28992')  

(bbox_spec <- glue::glue_collapse(bbox_28992,sep=','))
typename  <- 'topp:gidw_groenbomen'
fields    <- 'boom_omschrijf,objec_omschrijf'
wfs6a      <-  WFS_getfeature(typename,bbox=bbox_spec,
                             propertyname=fields )
print(wfs6a,n=5,digits=5)

(bbox_spec <- paste0(glue::glue_collapse(bbox_wgs84,sep=','),',EPSG:4326'))
wfs6b      <-  WFS_getfeature(typename,bbox=bbox_spec,
                             propertyname=fields )
print(wfs6b,n=5,digits=5)
```
[[back to contents]](#TOC) [[back to 'Retrieve the actual data']](#retrieve)

##### retrieve features in a bounding box with additional filtering {#retrieve_boundingbox-cqlfilter}
A combination of `cql_filter=` or `filter=` with `bbox=` is not allowed. In that case the bbox filtering has to be included in the `cql_filter=` or `filter=` construct. First we show this for the `cql_filter=` construct.  
Note the quotes around `EPSG:4326` that were not necessary in the `bbox=` case.

```{r retrieve-boundingbox-cqlfilter}
typename  <- 'topp:gidw_groenbomen'
fields    <- 'boom_omschrijf,objec_omschrijf'
tree_name <- "Alnus glutinosa ''Laciniata''"  
tree_exp  <- glue::glue("boom_omschrijf='{tree_name}'")
bbox_spec <- glue::glue_collapse(bbox_28992,sep=',')
( cql_spec<- paste0(tree_exp,' and bbox(geometrie,',bbox_spec,')') )
wfs7a      <-  WFS_getfeature(typename,cql_filter=cql_spec,
                             propertyname=fields )
print(wfs7a,n=5,digits=5)

bbox_spec <- paste0(glue::glue_collapse(bbox_wgs84,sep=','),",'EPSG:4326'")
( cql_spec<- paste0(tree_exp,' and bbox(geometrie,',bbox_spec,')') )
wfs7b      <-  WFS_getfeature(typename,cql_filter=cql_spec,
                             propertyname=fields,srsName='EPSG:4326' )
print(wfs7b,n=5,digits=5)
```

Instead of `cql_filter=` we can also use `filter=` . In that case we have to specify the query in xml terms. To do this we can use the `build_filter` with the `fg` and `bg` functions. In the `xml_query1` filter we specify the filter in the default CRS; when we use it in `wfs7c` we specify that we want the coordinates in longitude/latitude (EPSG:4326). In `xml_query2` and `wfs7d` we do it the other way around.

```{r retrieve-buildfilter}
xml_query1=build_filter(version='1.1.0',
     fg("And"
           , propeq_xml('topp:boom_omschrijf',"Alnus glutinosa 'Laciniata'")
           , bbox_xml("geometrie","EPSG:28992",bbox_28992)
         )
  )
cat(xml_query1)
typename  <- 'topp:gidw_groenbomen'
fields    <- 'boom_omschrijf,objec_omschrijf'
wfs7c    <-  WFS_getfeature(typename
             ,version='1.1.0'
             ,filter=xml_query1
             ,propertyname=fields
             ,srsName='EPSG:4326')
print(wfs7c,n=5,digits=5)

xml_query2=build_filter(version='2.0.0',
     fg("And"
           , propeq_xml('topp:boom_omschrijf',"Alnus glutinosa 'Laciniata'")
           , bbox_xml("geometrie","EPSG:4326",bbox_wgs84)
         )
  )
cat(xml_query2)
wfs7d    <-  WFS_getfeature(typename
             ,version='2.0.0'
             ,filter=xml_query2
             ,propertyname=fields
             ,srsName='EPSG:28992')
print(wfs7d,n=5,digits=5)

```

[[back to contents]](#TOC) [[back to 'Retrieve the actual data']](#retrieve)

